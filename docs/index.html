<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Nearest Orthodox Church</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<style>
  :root { --bg:#0e1117; --fg:#e6edf3; --muted:#9aa4ad; --brand:#3b82f6; }
  html,body{height:100%;margin:0}
  body{background:var(--bg);color:var(--fg);font:15px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial}
  #app{display:grid;grid-template-rows:auto 1fr auto;height:100%}
  header{padding:10px 12px;border-bottom:1px solid #1f242b;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  header h1{font-size:16px;margin:0}
  header .status{font-size:12px;color:var(--muted)}
  #map{height:100%}
  .panel{padding:10px 12px;border-top:1px solid #1f242b;display:grid;gap:8px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button,a.btn{background:var(--brand);color:#fff;border:0;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
  button:disabled{opacity:.6;cursor:not-allowed}
  .secondary{background:#222a35;color:var(--fg)}
  .error{color:#ff6b6b}
  .hidden{display:none}
  .pill{padding:5px 10px;border-radius:999px;background:#1b2330;color:var(--muted);font-size:12px}
  .list{font-size:13px;color:var(--muted)} .list b{color:var(--fg)}
  .credit{color:var(--muted);font-size:12px;text-align:center}
  /* –ú–∞—Ä–∫–µ—Ä—ã */
  .marker{width:18px;height:18px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.35)}
  .marker-user{background:#3b82f6}           /* —Å–∏–Ω–∏–π ‚Äì —Ç—ã */
  .marker-church{background:#ef4444}         /* –∫—Ä–∞—Å–Ω—ã–π ‚Äì —Ö—Ä–∞–º—ã */
  .leaflet-popup-content a{color:var(--brand)}
  /* –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –ø–ª–∞—à–∫–∞ (–≤–∫–ª—é—á–∞–µ—Ç—Å—è ?debug=1) */
  #debug{position:fixed;left:0;right:0;bottom:0;max-height:40%;overflow:auto;padding:8px;background:rgba(0,0,0,.85);color:#fff;font:12px/1.4 monospace;display:none;z-index:99999}
</style>
</head>
<body>
<div id="app">
  <header>
    <h1>üïØÔ∏è Nearest Orthodox Church</h1>
    <span class="status" id="status">Loading UI‚Ä¶</span>
    <span class="pill" id="distancePill" hidden>‚Äì</span>
  </header>
  <div id="map"></div>
  <div class="panel">
    <div class="row">
      <button id="locateBtn" class="secondary">Locate me</button>
      <button id="loadBtn">Load churches</button>
      <button id="routeBtn" class="secondary">Route to nearest</button>
      <a id="externalBtn" class="btn secondary" target="_blank" rel="noopener">Open in Maps</a>
      <button id="retryBtn" class="secondary hidden">Try again</button>
      <button id="testMskBtn" class="secondary">Test Moscow</button>
    </div>
    <div class="list" id="info">Map is ready. Use ‚ÄúLocate me‚Äù or ‚ÄúTest Moscow‚Äù, then ‚ÄúLoad churches‚Äù.</div>
    <div class="error hidden" id="error"></div>
    <div class="credit">Data: ¬© OpenStreetMap contributors ‚Ä¢ Routing: OSRM</div>
  </div>
</div>
<div id="debug"></div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<script>
(function(){
  /* ======= –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –ø–∞–Ω–µ–ª—å –ø–æ ?debug=1 ======= */
  (function(){
    var dbg = document.getElementById('debug');
    var enabled = new URLSearchParams(location.search).has('debug');
    function show(){ dbg.style.display='block'; }
    function fmt(a){ try{ return (typeof a==='object')?JSON.stringify(a):String(a); }catch(_){ return String(a); } }
    function log(prefix,args){ if(!enabled) return; show(); dbg.innerHTML += prefix+' '+Array.from(args).map(fmt).join(' ')+'<br>'; }
    window.addEventListener('error', function(e){ log('‚ùå',[e.message,'@',e.filename,':',e.lineno,':',e.colno]); });
    window.addEventListener('unhandledrejection', function(e){ log('üí•',[e.reason&&(e.reason.message||e.reason)]); });
    var _log=console.log,_err=console.error,_warn=console.warn;
    console.log=function(){ log('‚ÑπÔ∏è',arguments); return _log.apply(console,arguments); };
    console.error=function(){ log('‚ùå',arguments); return _err.apply(console,arguments); };
    console.warn=function(){ log('‚ö†Ô∏è',arguments); return _warn.apply(console,arguments); };
    if(enabled){ show(); dbg.innerHTML+='üü¢ Debug overlay ON<br>'; }
  })();

  /* ======= —Ç–µ–º–∞ –¢–µ–ª–µ–≥–∏ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ) ======= */
  var tg = window.Telegram && window.Telegram.WebApp;
  if (tg) {
    tg.ready(); tg.expand();
    document.documentElement.style.setProperty('--bg', (tg.themeParams&&tg.themeParams.bg_color)||'#0e1117');
    document.documentElement.style.setProperty('--fg', (tg.themeParams&&tg.themeParams.text_color)||'#e6edf3');
    document.documentElement.style.setProperty('--muted', (tg.themeParams&&tg.themeParams.hint_color)||'#9aa4ad');
    document.documentElement.style.setProperty('--brand', (tg.themeParams&&tg.themeParams.button_color)||'#3b82f6');
  }

  /* ======= —Å—Å—ã–ª–∫–∏ –Ω–∞ DOM ======= */
  var statusEl=document.getElementById('status');
  var errorEl=document.getElementById('error');
  var infoEl=document.getElementById('info');
  var locateBtn=document.getElementById('locateBtn');
  var loadBtn=document.getElementById('loadBtn');
  var routeBtn=document.getElementById('routeBtn');
  var retryBtn=document.getElementById('retryBtn');
  var testMskBtn=document.getElementById('testMskBtn');
  var externalBtn=document.getElementById('externalBtn');
  var distancePill=document.getElementById('distancePill');

  /* ======= —Å–æ—Å—Ç–æ—è–Ω–∏–µ ======= */
  var map, userMarker, routeLayer;
  var userLatLng=null, nearest=null;

  /* ======= –∏–∫–æ–Ω–∫–∏ ======= */
  var userIcon=L.divIcon({className:'marker marker-user',iconSize:[18,18],iconAnchor:[9,9],popupAnchor:[0,-10]});
  var churchIcon=L.divIcon({className:'marker marker-church',iconSize:[16,16],iconAnchor:[8,8],popupAnchor:[0,-10]});

  /* ======= —É—Ç–∏–ª–∏—Ç—ã ======= */
  function km(m){ return (m/1000).toFixed(2)+' km'; }
  function hav(lat1,lon1,lat2,lon2){
    var R=6371e3, toRad=function(v){return v*Math.PI/180;};
    var dLat=toRad(lat2-lat1), dLon=toRad(lat2-lon1?NaN:NaN); // placeholder to avoid typos
  }
  // –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—á–∞—Ç–∫–∏:
  function hav(lat1_,lon1_,lat2_,lon2_){
    var R=6371e3, toRad=function(v){return v*Math.PI/180;};
    var dLat=toRad(lat2_-lat1_), dLon=toRad(lon2_-lon1_);
    var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(toRad(lat1_))*Math.cos(toRad(lat2_))*Math.sin(dLon/2)*Math.sin(dLon/2);
    return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  }
  function setStatus(t){ statusEl.textContent=t; }
  function setError(t){ errorEl.textContent=t||''; errorEl.classList.toggle('hidden',!t); }

  /* ======= –∫–∞—Ä—Ç–∞ ======= */
  function initMap(lat,lon){
    map=L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
    userMarker=L.marker([lat,lon],{icon:userIcon,title:'You'}).addTo(map);
    map.setView([lat,lon],14);
    setStatus('Map ready');
  }

  /* ======= –∫–∞—Ä—Ç–æ—á–∫–∞ ======= */
  function wikiUrl(w){
    if(!w) return null;
    var parts=w.split(':'); if(parts.length<2) return null;
    var lang=parts.shift(); var title=parts.join(':').trim().replace(/\s/g,'_');
    return lang&&title?('https://'+lang+'.wikipedia.org/wiki/'+encodeURIComponent(title)):null;
  }
  function buildPopup(p){
    var t=p.tags||{};
    var addr=[t['addr:street'],t['addr:housenumber']].filter(Boolean).join(' ');
    var city=t['addr:city']||t['addr:suburb'];
    var denom=t.denomination? t.denomination.replace(/_/g,' ') : null;
    var phone=t.phone||t['contact:phone'];
    var site=t.website||t.url;
    var wiki=t.wikipedia? wikiUrl(t.wikipedia) : (t.wikidata? ('https://www.wikidata.org/wiki/'+t.wikidata):null);
    var rows=[
      'üïç <b>'+p.name+'</b>',
      (addr||city)? ('üìç '+[addr,city].filter(Boolean).join(', ')) : null,
      denom? ('‚úùÔ∏è '+denom):null,
      t.opening_hours? ('‚è∞ '+t.opening_hours):null,
      phone? ('üìû <a href="tel:'+phone.replace(/[^+\d]/g,'')+'">'+phone+'</a>'):null,
      site? ('üåê <a href="'+site+'" target="_blank" rel="noopener">Website</a>'):null,
      wiki? ('üìñ <a href="'+wiki+'" target="_blank" rel="noopener">About</a>'):null,
      (userLatLng&&typeof userLatLng.lat==='number')? ('üìè '+km(hav(userLatLng.lat,userLatLng.lon,p.lat,p.lon))):null
    ].filter(Boolean);
    return rows.join('<br>');
  }

  /* ======= Overpass —Å —Ä–æ—Ç–∞—Ü–∏–µ–π –∑–µ—Ä–∫–∞–ª + –±—ç–∫–æ—Ñ—Ñ ======= */
  async function queryOrthodox(lat, lon, radius){
    var q =
      '[out:json][timeout:30];\n' +
      '(\n' +
      '  nwr["amenity"~"place_of_worship|monastery",i]["religion"~"orthodox|christian",i](around:'+radius+','+lat+','+lon+');\n' +
      '  nwr["amenity"~"place_of_worship|monastery",i]["denomination"~"orthodox|eastern_orthodox|old.*believer|.*orthodox.*",i](around:'+radius+','+lat+','+lon+');\n' +
      '  nwr["amenity"~"place_of_worship|monastery",i]["name"~"Orthodox|–ü—Ä–∞–≤–æ—Å–ª–∞–≤",i](around:'+radius+','+lat+','+lon+');\n' +
      '  nwr["building"~"church|chapel|cathedral|monastery",i]["denomination"~"orthodox|eastern_orthodox|old.*believer|.*orthodox.*",i](around:'+radius+','+lat+','+lon+');\n' +
      ');\n' +
      'out center;';

    var endpoints = [
      'https://z.overpass-api.de/api/interpreter',
      'https://overpass-api.de/api/interpreter',
      'https://overpass.kumi.systems/api/interpreter',
      'https://overpass.openstreetmap.fr/api/interpreter',
      'https://overpass.osm.ch/api/interpreter',
      'https://overpass.openstreetmap.ru/api/interpreter'
    ];
    var start = Math.floor(Math.random() * endpoints.length);

    async function tryOnce(url){
      var res = await fetch(url, {
        method:'POST',
        body:q,
        headers:{'Content-Type':'text/plain','Accept':'application/json'},
        cache:'no-store',
        referrerPolicy:'no-referrer',
        mode:'cors'
      });
      if ([429,502,503,504].includes(res.status)) throw new Error('BUSY_'+res.status);
      var text = await res.text();
      var t = (text||'').trim();
      if (!t || t.charAt(0) !== '{') throw new Error('NOT_JSON');
      var data; try { data = JSON.parse(t); } catch(_){ throw new Error('BAD_JSON'); }

      var seen = {}; var list = [];
      var arr = (data && data.elements) ? data.elements : [];
      for (var i=0;i<arr.length;i++){
        var el = arr[i];
        var latc = el.type==='node' ? el.lat : (el.center && el.center.lat);
        var lonc = el.type==='node' ? el.lon : (el.center && el.center.lon);
        if (!latc || !lonc) continue;
        var key = el.type + '/' + el.id;
        if (seen[key]) continue; seen[key] = 1;
        var tags = el.tags || {};
        var name = tags['name:ru'] || tags.name || '–ü—Ä–∞–≤–æ—Å–ª–∞–≤–Ω—ã–π —Ö—Ä–∞–º';
        list.push({ id:key, name:name, lat:latc, lon:lonc, tags:tags });
      }
      return list.slice(0, 400);
    }

    var lastErr = null;
    for (var step=0; step<endpoints.length*2; step++){
      var url = endpoints[(start+step)%endpoints.length];
      try { return await tryOnce(url); }
      catch(e){ lastErr = e; await new Promise(function(r){ setTimeout(r, 500 + Math.random()*700); }); }
    }
    throw (lastErr || new Error('Overpass failed'));
  }

  /* ======= –æ—Ñ—Ñ–ª–∞–π–Ω-—Ñ–æ–ª–±—ç–∫ (—á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–Ω–¥–µ—Ä) ======= */
  function fallbackPlaces(){
    return [
      { id:'node/1', name:'–•—Ä–∞–º –•—Ä–∏—Å—Ç–∞ –°–ø–∞—Å–∏—Ç–µ–ª—è', lat:55.744724, lon:37.605053, tags:{'name:ru':'–•—Ä–∞–º –•—Ä–∏—Å—Ç–∞ –°–ø–∞—Å–∏—Ç–µ–ª—è', denomination:'russian_orthodox' } },
      { id:'node/2', name:'–°–æ–±–æ—Ä –í–∞—Å–∏–ª–∏—è –ë–ª–∞–∂–µ–Ω–Ω–æ–≥–æ', lat:55.752523, lon:37.623086, tags:{'name:ru':'–°–æ–±–æ—Ä –í–∞—Å–∏–ª–∏—è –ë–ª–∞–∂–µ–Ω–Ω–æ–≥–æ', denomination:'russian_orthodox' } },
      { id:'node/3', name:'–ù–æ–≤–æ–¥–µ–≤–∏—á–∏–π –º–æ–Ω–∞—Å—Ç—ã—Ä—å', lat:55.726065, lon:37.554676, tags:{'name:ru':'–ù–æ–≤–æ–¥–µ–≤–∏—á–∏–π –º–æ–Ω–∞—Å—Ç—ã—Ä—å', denomination:'eastern_orthodox' } }
    ];
  }

  /* ======= –ª–æ–≥–∏–∫–∞ ======= */
  function externalMapLink(to){
    var lat=to.lat.toFixed(6), lon=to.lon.toFixed(6);
    var ua=navigator.userAgent.toLowerCase();
    if(/iphone|ipad|ipod/.test(ua)) return 'http://maps.apple.com/?daddr='+lat+','+lon+'&dirflg=w';
    if(/android/.test(ua)) return 'geo:'+lat+','+lon+'?q='+lat+','+lon+'(Orthodox%20Church)';
    return 'https://www.google.com/maps/dir/?api=1&destination='+lat+','+lon+'&travelmode=walking';
  }

  function placeChurchMarkers(places){
    var best=null;
    for (var i=0;i<places.length;i++){
      var p=places[i];
      var d = (userLatLng) ? hav(userLatLng.lat,userLatLng.lon,p.lat,p.lon) : 1e18;
      if (!best || d < best.distance) { best = Object.assign({ distance: d }, p); }
      L.marker([p.lat,p.lon],{icon:churchIcon,title:p.name}).addTo(map).bindPopup(buildPopup(p));
    }
    return best;
  }

  async function drawRoute(from,to){
    var url='https://router.project-osrm.org/route/v1/foot/'+from.lon+','+from.lat+';'+to.lon+','+to.lat+'?overview=full&geometries=geojson';
    var res=await fetch(url); if(!res.ok) throw new Error('Routing '+res.status);
    var data=await res.json(); var r=data.routes&&data.routes[0]; if(!r) throw new Error('No route');
    var line=L.geoJSON(r.geometry); if(routeLayer) routeLayer.remove(); routeLayer=line.addTo(map);
    distancePill.textContent=km(r.distance); distancePill.hidden=false;
    map.fitBounds(line.getBounds(),{padding:[30,30]});
    infoEl.innerHTML='Routing to <b>'+to.name+'</b> ¬∑ Distance: <b>'+km(r.distance)+'</b>';
  }

  async function loadChurchesAt(lat,lon){
    setError(''); setStatus('Loading churches‚Ä¶'); retryBtn.classList.add('hidden');
    try{
      var places = await queryOrthodox(lat, lon, 3000).catch(function(){return[];});
      if(!places.length) places = await queryOrthodox(lat, lon, 10000).catch(function(){return[];});
      if(!places.length) places = await queryOrthodox(lat, lon, 30000).catch(function(){return[];});
      if(!places.length){
        // –æ—Ñ—Ñ–ª–∞–π–Ω –¥–µ–º–æ, —á—Ç–æ–±—ã –±—ã–ª–æ —á—Ç–æ —É–≤–∏–¥–µ—Ç—å
        places = fallbackPlaces();
        if (places.length){
          nearest = placeChurchMarkers(places);
          setStatus('Using offline sample (Overpass busy)');
          infoEl.innerHTML = 'Showing sample Moscow churches. Try ‚ÄúLoad churches‚Äù again later.';
          externalBtn.href = externalMapLink(nearest);
          externalBtn.textContent = 'Open in Maps';
          return;
        }
        setStatus('No results');
        infoEl.textContent='Nothing found nearby. Try again later.';
        retryBtn.classList.remove('hidden');
        return;
      }
      nearest = placeChurchMarkers(places);
      setStatus('Nearest found');
      infoEl.innerHTML='Nearest: <b>'+nearest.name+'</b>';
      externalBtn.href=externalMapLink(nearest);
      externalBtn.textContent='Open in Maps';
    }catch(e){
      console.error(e);
      setStatus('Overpass busy');
      setError('The service is rate-limited. Try again.');
      retryBtn.classList.remove('hidden');
    }
  }

  /* ======= –∫–Ω–æ–ø–∫–∏ ======= */
  locateBtn.addEventListener('click', function(){
    setStatus('Getting location‚Ä¶'); setError('');
    navigator.geolocation.getCurrentPosition(function(pos){
      var lat=pos.coords.latitude, lon=pos.coords.longitude;
      userLatLng={lat:lat,lon:lon};
      if(!map) initMap(lat,lon); else { userMarker.setLatLng([lat,lon]); map.setView([lat,lon],14); }
      setStatus('Location set. Press ‚ÄúLoad churches‚Äù.');
      infoEl.textContent='Location acquired. Now press ‚ÄúLoad churches‚Äù.';
    }, function(err){
      console.warn(err);
      setStatus('Location error ‚Äì using map center');
      setError('Could not get location. Move map and press ‚ÄúLoad churches‚Äù.');
      if(!map) initMap(55.751244,37.618423);
      var c=map.getCenter(); userLatLng={lat:c.lat,lon:c.lng};
    }, {enableHighAccuracy:false,maximumAge:60000,timeout:30000});
  });

  loadBtn.addEventListener('click', function(){
    setError('');
    if(!map){ initMap(55.751244,37.618423); }
    var center=map.getCenter();
    if(!userLatLng) userLatLng={lat:center.lat,lon:center.lng};
    loadChurchesAt(userLatLng.lat, userLatLng.lon);
  });

  routeBtn.addEventListener('click', async function(){
    if(!userLatLng||!nearest){ setError('No target yet. Press ‚ÄúLoad churches‚Äù first.'); return; }
    var old=routeBtn.textContent; routeBtn.disabled=true; routeBtn.textContent='Routing‚Ä¶';
    try{ await drawRoute(userLatLng, nearest); }catch(e){ console.error(e); setError('Could not draw route. Use the external map button.'); }
    finally{ routeBtn.disabled=false; routeBtn.textContent=old; }
  });

  retryBtn.addEventListener('click', function(){
    setError(''); retryBtn.classList.add('hidden');
    var c=map.getCenter(); if(!userLatLng) userLatLng={lat:c.lat,lon:c.lng};
    loadChurchesAt(userLatLng.lat, userLatLng.lon);
  });

  testMskBtn.addEventListener('click', function(){
    var lat=55.751244, lon=37.618423;
    userLatLng={lat:lat,lon:lon};
    if(!map) initMap(lat,lon); else map.setView([lat,lon],14);
    infoEl.textContent='Testing near Moscow center. Press ‚ÄúLoad churches‚Äù.';
  });

  /* ======= —Å—Ç–∞—Ä—Ç: —Ä–∏—Å—É–µ–º –∫–∞—Ä—Ç—É (–±–µ–∑ –∞–≤—Ç–æ–ø–æ–∏—Å–∫–∞) ======= */
  window.addEventListener('load', function(){
    initMap(55.751244, 37.618423); // –≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏—à—å –∫–∞—Ä—Ç—É
    setStatus('Map ready. Press ‚ÄúLocate me‚Äù or ‚ÄúTest Moscow‚Äù.');
  });
})();
</script>
</body>
</html>
