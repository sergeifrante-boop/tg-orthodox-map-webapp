<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Nearest Orthodox Church</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <style>
      :root { --bg:#0e1117; --fg:#e6edf3; --muted:#9aa4ad; --brand:#3b82f6; }
      html,body{height:100%;margin:0}
      body{background:var(--bg);color:var(--fg);font:15px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial}
      #app{display:grid;grid-template-rows:auto 1fr auto;height:100%}
      header{padding:10px 12px;border-bottom:1px solid #1f242b;display:flex;gap:8px;align-items:center}
      header h1{font-size:16px;margin:0}
      header .status{font-size:12px;color:var(--muted)}
      #map{height:100%}
      .panel{padding:10px 12px;border-top:1px solid #1f242b;display:grid;gap:8px}
      .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
      button,a.btn{background:var(--brand);color:#fff;border:0;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
      button:disabled{opacity:.6;cursor:not-allowed}
      .secondary{background:#222a35;color:var(--fg)}
      .error{color:#ff6b6b}
      .hidden{display:none}
      .pill{padding:5px 10px;border-radius:999px;background:#1b2330;color:var(--muted);font-size:12px}
      .list{font-size:13px;color:var(--muted)} .list b{color:var(--fg)}
      .credit{color:var(--muted);font-size:12px;text-align:center}

      /* ==== –ö–ê–°–¢–û–ú–ù–´–ï –ú–ê–†–ö–ï–†–´ ==== */
      .marker{width:18px;height:18px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.35)}
      .marker-user{background:#3b82f6}   /* —Ç—ã ‚Äî —Å–∏–Ω–∏–π */
      .marker-church{background:#ef4444} /* —Ö—Ä–∞–º—ã ‚Äî –∫—Ä–∞—Å–Ω—ã–µ */
      .leaflet-popup-content a{color:var(--brand)}
    </style>
  </head>
  <body>
    <div id="app">
      <header>
        <h1>üïØÔ∏è Nearest Orthodox Church</h1>
        <span class="status" id="status">Initializing‚Ä¶</span>
        <span class="pill" id="distancePill" hidden>‚Äì</span>
      </header>
      <div id="map"></div>
      <div class="panel">
        <div class="row">
          <button id="recenterBtn" class="secondary">Recenter</button>
          <button id="routeBtn">Route to nearest</button>
          <a id="externalBtn" class="btn secondary" target="_blank" rel="noopener">Open in Maps</a>
        </div>
        <div class="list" id="info">Waiting for location‚Ä¶</div>
        <div class="error hidden" id="error"></div>
        <div class="credit">Data: ¬© OpenStreetMap contributors ‚Ä¢ Routing by OSRM</div>
      </div>
    </div>

    <!-- Telegram WebApp SDK (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω) -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <script>
      /* ====== Telegram —Ç–µ–º–∞ (–∫–∞–∫ –≤ –ø–µ—Ä–≤–æ–º —Ä–∞–±–æ—á–µ–º —Ñ–∞–π–ª–µ) ====== */
      const tg = window.Telegram?.WebApp;
      if (tg) {
        tg.ready(); tg.expand();
        document.documentElement.style.setProperty('--bg', tg.themeParams?.bg_color || '#0e1117');
        document.documentElement.style.setProperty('--fg', tg.themeParams?.text_color || '#e6edf3');
        document.documentElement.style.setProperty('--muted', tg.themeParams?.hint_color || '#9aa4ad');
        document.documentElement.style.setProperty('--brand', tg.themeParams?.button_color || '#3b82f6');
      }

      /* ====== DOM ====== */
      const statusEl = document.getElementById('status');
      const errorEl = document.getElementById('error');
      const infoEl = document.getElementById('info');
      const routeBtn = document.getElementById('routeBtn');
      const recenterBtn = document.getElementById('recenterBtn');
      const externalBtn = document.getElementById('externalBtn');
      const distancePill = document.getElementById('distancePill');

      /* ====== —Å–æ—Å—Ç–æ—è–Ω–∏–µ ====== */
      let map, userMarker, routeLayer;
      let userLatLng = null;
      let nearest = null;

      /* ====== —É—Ç–∏–ª–∏—Ç—ã ====== */
      function km(m){ return (m/1000).toFixed(2) + ' km'; }
      function hav(lat1, lon1, lat2, lon2){
        const R=6371e3, toRad=v=>v*Math.PI/180;
        const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
        const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
        return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
      }
      function setStatus(t){ statusEl.textContent=t; }
      function setError(t){ errorEl.textContent=t||''; errorEl.classList.toggle('hidden',!t); }

      /* ====== –∏–∫–æ–Ω–∫–∏-–º–∞—Ä–∫–µ—Ä—ã ====== */
      const userIcon = L.divIcon({ className:'marker marker-user',  iconSize:[18,18], iconAnchor:[9,9], popupAnchor:[0,-10] });
      const churchIcon = L.divIcon({ className:'marker marker-church',iconSize:[16,16], iconAnchor:[8,8], popupAnchor:[0,-10] });

      /* ====== –∫–∞—Ä—Ç–∞ ====== */
      function initMap(lat, lon){
        map = L.map('map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
        userMarker = L.marker([lat, lon], { icon:userIcon, title:'You' }).addTo(map);
        map.setView([lat, lon], 15);
      }

      /* ====== –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–ø–∞–ø–∞ ====== */
      function wikiUrl(wikipediaTag){
        if(!wikipediaTag) return null;
        const parts = wikipediaTag.split(':'); if(parts.length<2) return null;
        const lang = parts.shift(); const title = parts.join(':').trim().replace(/\s/g,'_');
        return lang && title ? `https://${lang}.wikipedia.org/wiki/${encodeURIComponent(title)}` : null;
      }
      function buildPopup(p){
        const t = p.tags || {};
        const addr = [t['addr:street'], t['addr:housenumber']].filter(Boolean).join(' ');
        const city = t['addr:city'] || t['addr:suburb'];
        const denom = t.denomination ? t.denomination.replace(/_/g,' ') : null;
        const phone = t.phone || t['contact:phone'];
        const site  = t.website || t.url;
        const wiki  = t.wikipedia ? wikiUrl(t.wikipedia) : (t.wikidata ? `https://www.wikidata.org/wiki/${t.wikidata}` : null);
        const rows = [
          `üïç <b>${p.name}</b>`,
          (addr||city) ? `üìç ${[addr, city].filter(Boolean).join(', ')}` : null,
          denom ? `‚úùÔ∏è ${denom}` : null,
          t.opening_hours ? `‚è∞ ${t.opening_hours}` : null,
          phone ? `üìû <a href="tel:${phone.replace(/[^+\d]/g,'')}">${phone}</a>` : null,
          site ? `üåê <a href="${site}" target="_blank" rel="noopener">Website</a>` : null,
          wiki ? `üìñ <a href="${wiki}" target="_blank" rel="noopener">About</a>` : null,
          (userLatLng && typeof userLatLng.lat==='number') ? `üìè ${km(hav(userLatLng.lat,userLatLng.lon,p.lat,p.lon))}` : null,
        ].filter(Boolean);
        return rows.join('<br>');
      }

      /* ====== Overpass (—Ä–∞—Å—à–∏—Ä–µ–Ω–æ, –∫–∞–∫ –ø—Ä–æ—Å–∏–ª) ====== */
      async function queryOrthodox(lat, lon, radius){
        // —à–∏—Ä–µ –ø–æ —Ç–µ–≥–∞–º + –º–æ–Ω–∞—Å—Ç—ã—Ä–∏ + —Ñ–æ–ª–±—ç–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
        const overpass =
          `[out:json][timeout:30];
          (
            nwr["amenity"~"place_of_worship|monastery",i]["religion"~"orthodox|christian",i](around:${radius},${lat},${lon});
            nwr["amenity"~"place_of_worship|monastery",i]["denomination"~"orthodox|eastern_orthodox|old.*believer|.*orthodox.*",i](around:${radius},${lat},${lon});
            nwr["amenity"~"place_of_worship|monastery",i]["name"~"Orthodox|–ü—Ä–∞–≤–æ—Å–ª–∞–≤",i](around:${radius},${lat},${lon});
            nwr["building"~"church|chapel|cathedral|monastery",i]["denomination"~"orthodox|eastern_orthodox|old.*believer|.*orthodox.*",i](around:${radius},${lat},${lon});
          );
          out center;`;

        const endpoints = [
          'https://z.overpass-api.de/api/interpreter',
          'https://overpass-api.de/api/interpreter',
          'https://overpass.kumi.systems/api/interpreter',
          'https://overpass.openstreetmap.fr/api/interpreter',
          'https://overpass.osm.ch/api/interpreter',
          'https://overpass.openstreetmap.ru/api/interpreter'
        ];
        let lastErr;
        // —Ä–∞–Ω–¥–æ–º–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ —Å—Ç–∞—Ä—Ç–∞, —á—Ç–æ–±—ã –Ω–µ –¥–æ–ª–±–∏—Ç—å –æ–¥–Ω–æ –∑–µ—Ä–∫–∞–ª–æ
        const start = Math.floor(Math.random()*endpoints.length);
        for (let i=0; i<endpoints.length; i++) {
          const url = endpoints[(start+i)%endpoints.length];
          try {
            const res = await fetch(url, {
              method: 'POST',
              body: overpass,
              headers: { 'Content-Type':'text/plain', 'Accept':'application/json' },
            });
            if ([429,502,503,504].includes(res.status)) throw new Error('Busy '+res.status);
            const text = await res.text();
            const t = (text||'').trim();
            if (!t || t[0] !== '{') throw new Error('Not JSON'); // –∏–Ω–æ–≥–¥–∞ –∑–µ—Ä–∫–∞–ª–æ —à–ª—ë—Ç HTML
            const data = JSON.parse(t);

            // –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º + –æ—Å—Ç–∞–≤–∏–º —Ç–µ–≥–∏ –¥–ª—è –ø–æ–ø–∞–ø–∞
            const list = [];
            const seen = new Set();
            for (const el of (data.elements||[])) {
              const latc = el.type==='node'? el.lat : (el.center && el.center.lat);
              const lonc = el.type==='node'? el.lon : (el.center && el.center.lon);
              if (!latc || !lonc) continue;
              const key = `${el.type}/${el.id}`;
              if (seen.has(key)) continue; seen.add(key);
              const tags = el.tags || {};
              const name = tags['name:ru'] || tags.name || '–ü—Ä–∞–≤–æ—Å–ª–∞–≤–Ω—ã–π —Ö—Ä–∞–º';
              list.push({ id:key, name, lat:latc, lon:lonc, tags });
            }
            return list.slice(0, 400);
          } catch(e){ lastErr=e; }
        }
        throw lastErr || new Error('Overpass failed');
      }

      /* ====== –º–∞—Ä–∫–µ—Ä—ã –∏ –≤—ã–±–æ—Ä –±–ª–∏–∂–∞–π—à–µ–≥–æ ====== */
      function pickNearest(places){
        let best=null;
        places.forEach(p=>{
          const d=hav(userLatLng.lat,userLatLng.lon,p.lat,p.lon);
          if(!best||d<best.distance) best={...p, distance:d};
          L.marker([p.lat,p.lon], { icon:churchIcon, title:p.name })
           .addTo(map).bindPopup(buildPopup(p));
        });
        return best;
      }

      /* ====== —Ä–æ—É—Ç–∏–Ω–≥ ====== */
      async function drawRoute(from,to){
        const url=`https://router.project-osrm.org/route/v1/foot/${from.lon},${from.lat};${to.lon},${to.lat}?overview=full&geometries=geojson`;
        const res=await fetch(url);
        if(!res.ok) throw new Error('Routing error '+res.status);
        const data=await res.json();
        const route=data.routes?.[0];
        if(!route) throw new Error('No route found');
        const line=L.geoJSON(route.geometry);
        if(routeLayer) routeLayer.remove();
        routeLayer=line.addTo(map);
        distancePill.textContent=km(route.distance);
        distancePill.hidden=false;
        map.fitBounds(line.getBounds(),{padding:[30,30]});
        infoEl.innerHTML=`Routing to <b>${to.name}</b> ¬∑ Distance: <b>${km(route.distance)}</b>`;
      }

      function externalMapLink(to){
        const lat=to.lat.toFixed(6), lon=to.lon.toFixed(6);
        const ua=navigator.userAgent.toLowerCase();
        if(/iphone|ipad|ipod/.test(ua)) return `http://maps.apple.com/?daddr=${lat},${lon}&dirflg=w`;
        if(/android/.test(ua)) return `geo:${lat},${lon}?q=${lat},${lon}(Orthodox%20Church)`;
        return `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=walking`;
      }

      /* ====== –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ (–∫–∞–∫ –≤ –ø–µ—Ä–≤–æ–º) ====== */
      async function searchFrom(lat, lon){
        setStatus('Searching nearby churches‚Ä¶');
        const found = await queryOrthodox(lat, lon, 3000).catch(()=>[]);
        const list  = found.length ? found : await queryOrthodox(lat, lon, 10000).catch(()=>[]);
        const places= list.length  ? list  : await queryOrthodox(lat, lon, 30000).catch(()=>[]);
        if(!places.length){
          setStatus('No nearby Orthodox churches found.');
          infoEl.textContent='Try moving the map or check again later.';
          routeBtn.disabled=true; externalBtn.classList.add('hidden'); return;
        }
        userLatLng={lat,lon};
        nearest = pickNearest(places);
        L.marker([nearest.lat,nearest.lon], { icon:churchIcon, title:nearest.name })
          .addTo(map).bindPopup(buildPopup(nearest)).openPopup();
        setStatus('Nearest found');
        infoEl.innerHTML=`Nearest: <b>${nearest.name}</b> ¬∑ ~${km(hav(lat,lon,nearest.lat,nearest.lon))} away`;
        externalBtn.href=externalMapLink(nearest);
        externalBtn.textContent='Open in Maps';
      }

      async function locateAndLoad(){
        setStatus('Getting location‚Ä¶');
        try{
          const pos = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:false,maximumAge:60000,timeout:30000}));
          const { latitude, longitude } = pos.coords;
          if(!map) initMap(latitude, longitude);
          if(userMarker) userMarker.setLatLng([latitude, longitude]);
          await searchFrom(latitude, longitude);
        } catch(err){
          console.warn('Geolocation error:', err);
          if(!map) initMap(55.751244, 37.618423); // Moscow center fallback
          setStatus('Location error ‚Äì using map center');
          const c = map.getCenter();
          await searchFrom(c.lat, c.lng);
        }
      }

      /* ====== –∫–Ω–æ–ø–∫–∏ ====== */
      recenterBtn.addEventListener('click', ()=>{ if(userLatLng) map.setView([userLatLng.lat,userLatLng.lon],15); });
      routeBtn.addEventListener('click', async ()=>{
        if(!userLatLng||!nearest) return;
        routeBtn.disabled=true; const old=routeBtn.textContent; routeBtn.textContent='Routing‚Ä¶';
        try{ await drawRoute(userLatLng,nearest); }
        catch(e){ console.error(e); setError('Could not draw route. Use the external map button.'); }
        finally{ routeBtn.disabled=false; routeBtn.textContent=old; }
      });

      /* ====== —Å—Ç–∞—Ä—Ç ====== */
      locateAndLoad();
    </script>
  </body>
</html>
